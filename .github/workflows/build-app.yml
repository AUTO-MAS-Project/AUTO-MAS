#   AUTO-MAS: A Multi-Script, Multi-Config Management and Automation Software
#   Copyright © 2024-2025 DLmaster361
#   Copyright © 2025 AUTO-MAS Team

#   This file is part of AUTO-MAS.

#   AUTO-MAS is free software: you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published
#   by the Free Software Foundation, either version 3 of the License,
#   or (at your option) any later version.

#   AUTO-MAS is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty
#   of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See
#   the GNU General Public License for more details.

#   You should have received a copy of the GNU General Public License
#   along with AUTO-MAS. If not, see <https://www.gnu.org/licenses/>.

#   Contact: DLmaster_361@163.com

name: 构建并发布应用程序

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:

  build:
    name: 构建 Windows 版本
    runs-on: windows-latest
    if: github.repository == 'AUTO-MAS-Project/AUTO-MAS' && (github.ref_name == 'main' || github.ref_name == 'dev')
    
    outputs:
      version_tag: ${{ steps.generate_version_info.outputs.version_tag }}
      is_prerelease: ${{ steps.generate_version_info.outputs.is_prerelease }}
      version_changelog: ${{ steps.generate_version_info.outputs.version_changelog }}

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: 签出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 构建应用程序
        run: |
          corepack enable
          corepack prepare yarn@4.9.1 --activate
          yarn install
          yarn build:lite

      - name: 检查构建产物
        run: |
          if (!(Test-Path "dist")) { 
            echo "ERROR: dist 目录未生成"
            exit 1 
          }
          Write-Host "SUCCESS: 构建产物生成成功"
          Write-Host ""
          Write-Host "构建产物列表:"
          Get-ChildItem -Path dist -Recurse -File | Select-Object FullName, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}
        shell: pwsh

      - name: 生成版本信息
        id: generate_version_info
        run: |
          $tempScript = "temp_version_script.js"
          @"
          const fs = require('fs');
          const path = require('path');

          let versionPath = '../res/version.json';
          if (!fs.existsSync(versionPath)) {
            versionPath = 'res/version.json';
          }
          const version = JSON.parse(fs.readFileSync(versionPath, 'utf8'));

          function versionText(versionNumb) {
            while (versionNumb.length < 4) versionNumb.push(0);
            if (versionNumb[3] === 0) {
              return ``v`${versionNumb.slice(0, 3).join('.')}``;
            } else {
              return ``v`${versionNumb.slice(0, 3).join('.')}-beta.`${versionNumb[3]}``;
            }
          }

          function versionInfoMarkdown(info) {
            let md = '';
            for (const [key, values] of Object.entries(info)) {
              md += ``## `${key}\n``;
              for (const v of values) md += ``- `${v}\n``;
            }
            return md;
          }

          const mainVersionNumb = version.main_version.split('.').map(Number);
          const versionTag = versionText(mainVersionNumb);
          const isPrerelease = versionTag.includes('-beta');

          const allVersionInfo = {};
          for (const v_i of Object.values(version.version_info)) {
            for (const [key, value] of Object.entries(v_i)) {
              if (!allVersionInfo[key]) allVersionInfo[key] = [];
              allVersionInfo[key].push(...value);
            }
          }
          const changelog = versionInfoMarkdown(allVersionInfo);

          const outputPath = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(outputPath, ``version_tag=`${versionTag}\n``);
          fs.appendFileSync(outputPath, ``is_prerelease=`${isPrerelease}\n``);
          fs.appendFileSync(outputPath, ``version_changelog<<EOF\n`${changelog}\nEOF\n``);
          "@ | Out-File -FilePath $tempScript -Encoding UTF8

          node $tempScript
          Remove-Item $tempScript
        shell: pwsh

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            frontend/dist/*.zip
          retention-days: 30

  release:
    name: 发布 GitHub 发行版
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 签出代码
        uses: actions/checkout@v4

      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: artifacts

      - name: 创建发行版分支与标签
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

          NEW_BRANCH="release/${{ needs.build.outputs.version_tag }}"
          TAG_NAME="${{ needs.build.outputs.version_tag }}"

          echo "Creating branch: $NEW_BRANCH"
          echo "Creating tag: $TAG_NAME"

          git checkout -b "$NEW_BRANCH"
          git push origin "$NEW_BRANCH"

          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"

      - name: 发布发行版
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ needs.build.outputs.version_tag }}
          body: ${{ needs.build.outputs.version_changelog }}
          files: artifacts/*
          prerelease: ${{ needs.build.outputs.is_prerelease }}

  mirrorchyan:
    name: 发布 MirrorChyan 版本
    runs-on: macos-latest
    needs: [build, release]

    steps:
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: 上传发行版文件
        uses: MirrorChyan/uploading-action@v1
        with:
          filetype: local
          filename: AUTO-MAS-Lite-Setup-${{ needs.build.outputs.version_tag }}-x64.zip
          version_name: ${{ needs.build.outputs.version_tag }}
          mirrorchyan_rid: AUTO_MAS
          upload_token: ${{ secrets.MirrorChyanUploadToken }}

      - name: 上传版本说明
        uses: MirrorChyan/release-note-action@v1
        with:
          version_name: ${{ needs.build.outputs.version_tag }}
          release_note: ${{ needs.build.outputs.version_changelog }}
          mirrorchyan_rid: AUTO_MAS
          upload_token: ${{ secrets.MirrorChyanUploadToken }}