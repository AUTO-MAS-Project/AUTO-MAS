<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketå¼ºåˆ¶è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .force-btn {
            background: #dc3545;
        }

        .force-btn:hover {
            background: #c82333;
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>WebSocketå¼ºåˆ¶è¿æ¥æµ‹è¯•å·¥å…·</h1>

        <div class="status" id="status">çŠ¶æ€ï¼šæœªçŸ¥</div>

        <div>
            <button onclick="testNormalConnect()">æµ‹è¯•æ­£å¸¸è¿æ¥</button>
            <button onclick="testForceConnect()" class="force-btn">æµ‹è¯•å¼ºåˆ¶è¿æ¥</button>
            <button onclick="testDirectConnect()">æµ‹è¯•ç›´æ¥WebSocketè¿æ¥</button>
            <button onclick="checkStatus()">æ£€æŸ¥è¿æ¥çŠ¶æ€</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        let ws = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'color: red;' :
                type === 'success' ? 'color: green;' :
                    type === 'warning' ? 'color: orange;' : '';
            logDiv.innerHTML += `<div style="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = `çŠ¶æ€ï¼š${message}`;
            statusDiv.className = `status ${type}`;
        }

        // æµ‹è¯•æ­£å¸¸è¿æ¥ï¼ˆé€šè¿‡å‰ç«¯æ¡†æ¶ï¼‰
        async function testNormalConnect() {
            log('ğŸ” æµ‹è¯•æ­£å¸¸è¿æ¥æ¨¡å¼...');
            updateStatus('æµ‹è¯•æ­£å¸¸è¿æ¥ä¸­...', 'warning');

            try {
                // è¿™é‡Œéœ€è¦è°ƒç”¨å‰ç«¯æ¡†æ¶çš„è¿æ¥æ–¹æ³•
                if (window.wsDebug && window.wsDebug.normalConnect) {
                    const result = await window.wsDebug.normalConnect();
                    if (result) {
                        log('âœ… æ­£å¸¸è¿æ¥æˆåŠŸ', 'success');
                        updateStatus('æ­£å¸¸è¿æ¥æˆåŠŸ', 'success');
                    } else {
                        log('âŒ æ­£å¸¸è¿æ¥å¤±è´¥', 'error');
                        updateStatus('æ­£å¸¸è¿æ¥å¤±è´¥', 'error');
                    }
                } else {
                    log('âš ï¸ wsDebug.normalConnect ä¸å¯ç”¨', 'warning');
                    updateStatus('è°ƒè¯•åŠŸèƒ½ä¸å¯ç”¨', 'warning');
                }
            } catch (error) {
                log(`âŒ æ­£å¸¸è¿æ¥å¼‚å¸¸: ${error}`, 'error');
                updateStatus('æ­£å¸¸è¿æ¥å¼‚å¸¸', 'error');
            }
        }

        // æµ‹è¯•å¼ºåˆ¶è¿æ¥ï¼ˆé€šè¿‡å‰ç«¯æ¡†æ¶ï¼‰
        async function testForceConnect() {
            log('ğŸš€ æµ‹è¯•å¼ºåˆ¶è¿æ¥æ¨¡å¼...');
            updateStatus('æµ‹è¯•å¼ºåˆ¶è¿æ¥ä¸­...', 'warning');

            try {
                if (window.wsDebug && window.wsDebug.forceConnect) {
                    const result = await window.wsDebug.forceConnect();
                    if (result) {
                        log('âœ… å¼ºåˆ¶è¿æ¥æˆåŠŸ', 'success');
                        updateStatus('å¼ºåˆ¶è¿æ¥æˆåŠŸ', 'success');
                    } else {
                        log('âŒ å¼ºåˆ¶è¿æ¥å¤±è´¥', 'error');
                        updateStatus('å¼ºåˆ¶è¿æ¥å¤±è´¥', 'error');
                    }
                } else {
                    log('âš ï¸ wsDebug.forceConnect ä¸å¯ç”¨', 'warning');
                    updateStatus('è°ƒè¯•åŠŸèƒ½ä¸å¯ç”¨', 'warning');
                }
            } catch (error) {
                log(`âŒ å¼ºåˆ¶è¿æ¥å¼‚å¸¸: ${error}`, 'error');
                updateStatus('å¼ºåˆ¶è¿æ¥å¼‚å¸¸', 'error');
            }
        }

        // æµ‹è¯•ç›´æ¥WebSocketè¿æ¥
        function testDirectConnect() {
            log('ğŸ”— æµ‹è¯•ç›´æ¥WebSocketè¿æ¥...');
            updateStatus('æµ‹è¯•ç›´æ¥è¿æ¥ä¸­...', 'warning');

            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    log('âš ï¸ WebSocketå·²ç»è¿æ¥ï¼Œå…ˆå…³é—­', 'warning');
                    ws.close();
                }

                ws = new WebSocket('ws://localhost:36163/api/core/ws');

                ws.onopen = () => {
                    log('âœ… ç›´æ¥WebSocketè¿æ¥æˆåŠŸ', 'success');
                    updateStatus('ç›´æ¥è¿æ¥æˆåŠŸ', 'success');
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');
                    } catch (e) {
                        log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'info');
                    }
                };

                ws.onerror = (error) => {
                    log(`âŒ WebSocketé”™è¯¯: ${error}`, 'error');
                    updateStatus('ç›´æ¥è¿æ¥é”™è¯¯', 'error');
                };

                ws.onclose = (event) => {
                    log(`ğŸ”’ WebSocketå…³é—­: code=${event.code}, reason="${event.reason}"`, 'warning');
                    updateStatus('è¿æ¥å·²å…³é—­', 'warning');
                };

            } catch (error) {
                log(`âŒ ç›´æ¥è¿æ¥å¼‚å¸¸: ${error}`, 'error');
                updateStatus('ç›´æ¥è¿æ¥å¼‚å¸¸', 'error');
            }
        }

        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        function checkStatus() {
            log('ğŸ” æ£€æŸ¥è¿æ¥çŠ¶æ€...');

            // æ£€æŸ¥ç›´æ¥WebSocket
            if (ws) {
                const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
                log(`ğŸ“¡ ç›´æ¥WebSocketçŠ¶æ€: ${states[ws.readyState]} (${ws.readyState})`);
            } else {
                log('ğŸ“¡ ç›´æ¥WebSocket: æœªåˆ›å»º');
            }

            // æ£€æŸ¥æ¡†æ¶WebSocket
            if (window.wsDebug) {
                try {
                    const info = window.wsDebug.getConnectionInfo ? window.wsDebug.getConnectionInfo() : {};
                    log(`ğŸ”§ æ¡†æ¶WebSocketçŠ¶æ€: ${JSON.stringify(info, null, 2)}`);

                    const storage = window.wsDebug.getGlobalStorage ? window.wsDebug.getGlobalStorage() : {};
                    log(`ğŸ’¾ å…¨å±€å­˜å‚¨çŠ¶æ€: allowNewConnection=${storage.allowNewConnection}, connectionReason="${storage.connectionReason}"`);

                    if (window.wsDebug.allowedReasons) {
                        log(`âœ… å…è®¸çš„è¿æ¥åŸå› : ${JSON.stringify(window.wsDebug.allowedReasons)}`);
                    }
                } catch (error) {
                    log(`âŒ æ£€æŸ¥æ¡†æ¶çŠ¶æ€å¼‚å¸¸: ${error}`, 'error');
                }
            } else {
                log('ğŸ”§ æ¡†æ¶WebSocketè°ƒè¯•åŠŸèƒ½ä¸å¯ç”¨');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            log('ğŸ“‹ WebSocketå¼ºåˆ¶è¿æ¥æµ‹è¯•å·¥å…·å·²åŠ è½½');
            checkStatus();
        });
    </script>
</body>

</html>